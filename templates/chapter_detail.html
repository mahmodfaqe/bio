{% extends "base.html" %}

{% block content %}
<div class="chapter-detail-container">
  <!-- Chapter Header -->
  <section class="chapter-header fade-in">
    <div class="chapter-header-content">
      <div class="chapter-badge">
        <span class="chapter-number">{{ chapter.order }}</span>
        <i class="chapter-main-icon {{ chapter.icon }}"></i>
      </div>
      <div class="chapter-info">
        <h1 class="chapter-main-title">{{ chapter.get_title(lang) }}</h1>
        <p class="chapter-main-description">{{ chapter.get_description(lang) }}</p>
        <div class="chapter-meta">
          <div class="meta-item">
            <i class="fas fa-file-alt"></i>
            <span>{{ slides|length }} {{ t['slides'] }}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-eye"></i>
            <span>{{ chapter.view_count }} {{ t['views'] if t.get('views') else 'views' }}</span>
          </div>
          <div class="meta-item">
            <i class="fas fa-clock"></i>
            <span>{{ chapter.updated_at.strftime('%Y-%m-%d') }}</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <span class="progress-text" id="progressText">0 / {{ slides|length }} {{ t['slides'] }}</span>
  </div>

  <!-- Slides Navigation -->
  {% if slides %}
  <section class="slides-navigation fade-in">
    <div class="slides-nav-header">
      <h2>{{ t['slides'] if t.get('slides') else 'Study Materials' }}</h2>
      <div class="view-controls">
        <button class="view-btn active" data-view="grid" title="Grid View">
          <i class="fas fa-th-large"></i>
        </button>
        <button class="view-btn" data-view="list" title="List View">
          <i class="fas fa-list"></i>
        </button>
      </div>
    </div>

    <!-- Grid View -->
    <div class="slides-grid" id="slidesGrid">
      {% for slide in slides %}
      <div class="slide-card" data-slide-id="{{ slide.id }}">
        <div class="slide-image-container">
          {% if slide.get_thumbnail_url() %}
            <img src="{{ slide.get_thumbnail_url() }}" alt="{{ slide.get_title(lang) }}" class="slide-image" loading="lazy">
          {% else %}
            <div class="slide-placeholder">
              <i class="fas fa-image"></i>
            </div>
          {% endif %}
          <div class="slide-overlay">
            <div class="slide-number">{{ loop.index }}</div>
            <button class="slide-bookmark" data-slide-id="{{ slide.id }}" title="Bookmark">
              <i class="fas fa-bookmark"></i>
            </button>
          </div>
        </div>

        <div class="slide-content">
          <h3 class="slide-title">{{ slide.get_title(lang) }}</h3>
          <p class="slide-description">
            {% if slide.get_content(lang) %}
              {{ slide.get_content(lang)[:120] }}{% if slide.get_content(lang)|length > 120 %}...{% endif %}
            {% else %}
              {{ t['slide_content'] if t.get('slide_content') else 'Study slide content' }}
            {% endif %}
          </p>

          <!-- Dynamic Sections Preview -->
          {% set dynamic_sections = slide.get_dynamic_sections() %}
          {% if dynamic_sections %}
          <div class="slide-sections-preview">
            <div class="sections-count">
              <i class="fas fa-list-ul"></i>
              <span>{{ dynamic_sections|length }} {{ t['sections'] if t.get('sections') else 'sections' }}</span>
            </div>
            <div class="sections-tags">
              {% for section in dynamic_sections[:3] %}
                {% set section_name = section.get('name_' + lang, section.get('name_en', '')) %}
                {% if section_name %}
                <span class="section-tag">{{ section_name }}</span>
                {% endif %}
              {% endfor %}
              {% if dynamic_sections|length > 3 %}
                <span class="section-tag more">+{{ dynamic_sections|length - 3 }}</span>
              {% endif %}
            </div>
          </div>
          {% endif %}

          <div class="slide-actions">
            <a href="{{ url_for('slide_detail', lang=lang, slide_id=slide.id) }}" class="btn-slide-view">
              <i class="fas fa-arrow-right"></i>
              {{ t['view_slide'] if t.get('view_slide') else 'View Slide' }}
            </a>
            <div class="slide-stats">
              <span class="views-count">
                <i class="fas fa-eye"></i>
                {{ slide.view_count }}
              </span>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- List View -->
    <div class="slides-list" id="slidesList" style="display: none;">
      {% for slide in slides %}
      <div class="slide-list-item" data-slide-id="{{ slide.id }}">
        <div class="slide-list-image">
          {% if slide.get_thumbnail_url() %}
            <img src="{{ slide.get_thumbnail_url() }}" alt="{{ slide.get_title(lang) }}" loading="lazy">
          {% else %}
            <div class="slide-list-placeholder">
              <i class="fas fa-image"></i>
            </div>
          {% endif %}
        </div>

        <div class="slide-list-content">
          <div class="slide-list-header">
            <span class="slide-list-number">{{ loop.index }}</span>
            <h3 class="slide-list-title">{{ slide.get_title(lang) }}</h3>
            <div class="slide-list-meta">
              <span class="views-count">
                <i class="fas fa-eye"></i>
                {{ slide.view_count }}
              </span>
              <button class="slide-bookmark" data-slide-id="{{ slide.id }}">
                <i class="fas fa-bookmark"></i>
              </button>
            </div>
          </div>

          {% if slide.get_content(lang) %}
          <p class="slide-list-description">{{ slide.get_content(lang)[:200] }}{% if slide.get_content(lang)|length > 200 %}...{% endif %}</p>
          {% endif %}

          <!-- Dynamic Sections in List View -->
          {% set dynamic_sections = slide.get_dynamic_sections() %}
          {% if dynamic_sections %}
          <div class="slide-list-sections">
            {% for section in dynamic_sections[:2] %}
              {% set section_name = section.get('name_' + lang, section.get('name_en', '')) %}
              {% if section_name %}
              <div class="list-section-item">
                <strong>{{ section_name }}:</strong>
                {% set bullets = section.get('bullets_' + lang, section.get('bullets_en', [])) %}
                {% if bullets %}
                  {{ bullets[0][:80] }}{% if bullets[0]|length > 80 %}...{% endif %}
                {% endif %}
              </div>
              {% endif %}
            {% endfor %}
          </div>
          {% endif %}

          <div class="slide-list-actions">
            <a href="{{ url_for('slide_detail', lang=lang, slide_id=slide.id) }}" class="btn-slide-view">
              <i class="fas fa-arrow-right"></i>
              {{ t['view_slide'] if t.get('view_slide') else 'View Slide' }}
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </section>
  {% else %}
  <!-- Empty State -->
  <section class="empty-state fade-in">
    <div class="empty-state-content">
      <i class="fas fa-file-alt empty-icon"></i>
      <h3>{{ t['no_slides'] if t.get('no_slides') else 'No study materials yet' }}</h3>
      <p>{{ t['no_slides_desc'] if t.get('no_slides_desc') else 'Study materials for this chapter will be added soon.' }}</p>
      {% if current_user.is_authenticated %}
      <a href="{{ url_for('add_slide', lang=lang) }}" class="btn btn-primary">
        <i class="fas fa-plus"></i>
        {{ t['add_slide'] if t.get('add_slide') else 'Add Slide' }}
      </a>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Quick Navigation -->
  <section class="quick-navigation fade-in">
    <h3>{{ t['quick_nav'] if t.get('quick_nav') else 'Quick Navigation' }}</h3>
    <div class="nav-buttons">
      {% set all_chapters = chapters if chapters else [] %}
      {% for nav_chapter in all_chapters %}
        {% if nav_chapter.id != chapter.id %}
        <a href="{{ url_for('chapter', lang=lang, chapter_id=nav_chapter.id) }}" class="nav-chapter-btn">
          <i class="{{ nav_chapter.icon }}"></i>
          <span>{{ nav_chapter.get_title(lang) }}</span>
        </a>
        {% endif %}
      {% endfor %}
    </div>
  </section>
</div>

<style>
/* Chapter Detail Specific Styles */
.chapter-detail-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem 0;
}

/* Chapter Header */
.chapter-header {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: 24px;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
  border: 1px solid var(--border-color);
  box-shadow: 0 8px 32px var(--shadow-light);
  position: relative;
  overflow: hidden;
}

.chapter-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.1));
  z-index: -1;
}

.chapter-header-content {
  display: flex;
  align-items: center;
  gap: 2rem;
}

.chapter-badge {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
  min-width: 120px;
}

.chapter-number {
  background: linear-gradient(135deg, var(--warm-gold), var(--accent-emerald));
  color: white;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}

.chapter-main-icon {
  font-size: 4rem;
  color: var(--primary-blue);
  opacity: 0.8;
}

.chapter-info {
  flex: 1;
}

.chapter-main-title {
  font-size: 3rem;
  font-weight: 800;
  color: var(--text-primary);
  margin-bottom: 1rem;
  letter-spacing: -0.5px;
}

.chapter-main-description {
  font-size: 1.3rem;
  color: var(--text-secondary);
  line-height: 1.7;
  margin-bottom: 2rem;
}

.chapter-meta {
  display: flex;
  gap: 2rem;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1rem;
  color: var(--text-secondary);
  background: var(--light-gray);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.meta-item i {
  color: var(--primary-blue);
}

/* Progress Bar */
.progress-container {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 2rem;
  padding: 1rem;
  background: var(--card-bg);
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.progress-bar {
  flex: 1;
  height: 8px;
  background: var(--light-gray);
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s ease;
}

.progress-text {
  font-size: 0.9rem;
  color: var(--text-secondary);
  font-weight: 600;
  white-space: nowrap;
}

/* Slides Navigation */
.slides-navigation {
  margin-bottom: 3rem;
}

.slides-nav-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border-color);
}

.slides-nav-header h2 {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
}

.view-controls {
  display: flex;
  gap: 0.5rem;
  background: var(--light-gray);
  padding: 0.25rem;
  border-radius: 8px;
  border: 1px solid var(--border-color);
}

.view-btn {
  background: none;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-secondary);
}

.view-btn.active {
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
  color: white;
  box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.view-btn:hover:not(.active) {
  color: var(--primary-blue);
  background: var(--background-primary);
}

/* Grid View */
.slides-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
  gap: 2rem;
}

.slide-card {
  background: var(--card-bg);
  backdrop-filter: blur(10px);
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--border-color);
  box-shadow: 0 4px 20px var(--shadow-light);
  transition: all 0.3s ease;
  cursor: pointer;
  position: relative;
}

.slide-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px var(--shadow-medium);
}

.slide-image-container {
  position: relative;
  height: 200px;
  overflow: hidden;
}

.slide-image {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.5s ease;
}

.slide-card:hover .slide-image {
  transform: scale(1.05);
}

.slide-placeholder {
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, var(--light-gray), var(--background-secondary));
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 3rem;
}

.slide-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(to bottom, rgba(0,0,0,0.4), transparent);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 1rem;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.slide-card:hover .slide-overlay {
  opacity: 1;
}

.slide-number {
  background: var(--warm-gold);
  color: white;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.9rem;
  font-weight: bold;
}

.slide-bookmark {
  background: rgba(255, 255, 255, 0.9);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  color: var(--text-secondary);
}

.slide-bookmark:hover {
  background: var(--warm-gold);
  color: white;
  transform: scale(1.1);
}

.slide-bookmark.bookmarked {
  background: var(--warm-gold);
  color: white;
}

.slide-content {
  padding: 1.5rem;
}

.slide-title {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
  line-height: 1.4;
}

.slide-description {
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 1rem;
  font-size: 0.95rem;
}

.slide-sections-preview {
  margin-bottom: 1.5rem;
}

.sections-count {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.75rem;
}

.sections-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.section-tag {
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 500;
}

.section-tag.more {
  background: var(--medium-gray);
}

.slide-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.btn-slide-view {
  background: linear-gradient(135deg, var(--accent-emerald), var(--secondary-teal));
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.btn-slide-view:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.slide-stats {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.views-count {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.9rem;
  color: var(--text-secondary);
}

/* List View */
.slides-list {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.slide-list-item {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1.5rem;
  border: 1px solid var(--border-color);
  box-shadow: 0 2px 10px var(--shadow-light);
  transition: all 0.3s ease;
  display: flex;
  gap: 1.5rem;
}

.slide-list-item:hover {
  box-shadow: 0 4px 20px var(--shadow-medium);
  transform: translateY(-2px);
}

.slide-list-image {
  width: 120px;
  height: 80px;
  border-radius: 8px;
  overflow: hidden;
  flex-shrink: 0;
}

.slide-list-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.slide-list-placeholder {
  width: 100%;
  height: 100%;
  background: var(--light-gray);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-secondary);
  font-size: 1.5rem;
}

.slide-list-content {
  flex: 1;
  min-width: 0;
}

.slide-list-header {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  margin-bottom: 0.75rem;
}

.slide-list-number {
  background: var(--warm-gold);
  color: white;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  font-weight: bold;
  flex-shrink: 0;
}

.slide-list-title {
  flex: 1;
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  line-height: 1.3;
}

.slide-list-meta {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.slide-list-description {
  color: var(--text-secondary);
  line-height: 1.6;
  margin-bottom: 1rem;
  font-size: 0.95rem;
}

.slide-list-sections {
  margin-bottom: 1rem;
}

.list-section-item {
  background: var(--light-gray);
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  line-height: 1.5;
}

.list-section-item:last-child {
  margin-bottom: 0;
}

.slide-list-actions {
  display: flex;
  justify-content: flex-end;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  background: var(--card-bg);
  border-radius: 20px;
  border: 1px solid var(--border-color);
}

.empty-icon {
  font-size: 4rem;
  color: var(--text-secondary);
  margin-bottom: 1.5rem;
  opacity: 0.5;
}

.empty-state h3 {
  font-size: 1.5rem;
  color: var(--text-primary);
  margin-bottom: 1rem;
}

.empty-state p {
  color: var(--text-secondary);
  margin-bottom: 2rem;
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

/* Quick Navigation */
.quick-navigation {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2rem;
  border: 1px solid var(--border-color);
}

.quick-navigation h3 {
  font-size: 1.3rem;
  color: var(--text-primary);
  margin-bottom: 1.5rem;
  text-align: center;
}

.nav-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
}

.nav-chapter-btn {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 1.5rem;
  background: var(--light-gray);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  text-decoration: none;
  color: var(--text-primary);
  transition: all 0.3s ease;
  font-weight: 500;
}

.nav-chapter-btn:hover {
  background: linear-gradient(135deg, var(--primary-blue), var(--secondary-teal));
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.nav-chapter-btn i {
  font-size: 1.1rem;
}

/* Responsive Design */
@media (max-width: 1200px) {
  .slides-grid {
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
}

@media (max-width: 768px) {
  .chapter-detail-container {
    padding: 1rem 0;
  }

  .chapter-header {
    padding: 2rem 1rem;
  }

  .chapter-header-content {
    flex-direction: column;
    text-align: center;
    gap: 1.5rem;
  }

  .chapter-main-title {
    font-size: 2rem;
  }

  .chapter-main-description {
    font-size: 1.1rem;
  }

  .chapter-meta {
    justify-content: center;
  }

  .slides-grid {
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  .slides-nav-header {
    flex-direction: column;
    gap: 1rem;
    align-items: center;
  }

  .slide-list-item {
    flex-direction: column;
    gap: 1rem;
  }

  .slide-list-image {
    width: 100%;
    height: 150px;
  }

  .progress-container {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .nav-buttons {
    flex-direction: column;
    align-items: center;
  }

  .nav-chapter-btn {
    width: 100%;
    max-width: 300px;
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .chapter-badge {
    min-width: auto;
  }

  .chapter-number {
    width: 50px;
    height: 50px;
    font-size: 1.2rem;
  }

  .chapter-main-icon {
    font-size: 3rem;
  }

  .meta-item {
    flex: 1;
    justify-content: center;
    min-width: 0;
  }

  .slide-content {
    padding: 1rem;
  }

  .quick-navigation {
    padding: 1.5rem;
  }
}

/* RTL Support */
[dir="rtl"] .chapter-header-content {
  flex-direction: row-reverse;
}

[dir="rtl"] .slide-list-item {
  flex-direction: row-reverse;
}

[dir="rtl"] .slide-list-header {
  flex-direction: row-reverse;
}

[dir="rtl"] .slide-actions {
  flex-direction: row-reverse;
}

/* Dark mode enhancements */
[data-theme="dark"] .slide-card {
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

[data-theme="dark"] .slide-card:hover {
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] .slide-placeholder {
  background: linear-gradient(135deg, var(--background-secondary), var(--light-gray));
}

/* Animation classes */
.fade-in {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Bookmark animation */
.slide-bookmark.animate {
  animation: bookmarkPulse 0.6s ease-out;
}

@keyframes bookmarkPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}

/* Loading states */
.slide-card.loading {
  opacity: 0.7;
  pointer-events: none;
}

.slide-card.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  animation: shimmer 1.5s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // View toggle functionality
  const viewBtns = document.querySelectorAll('.view-btn');
  const slidesGrid = document.getElementById('slidesGrid');
  const slidesList = document.getElementById('slidesList');

  viewBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const view = this.getAttribute('data-view');

      // Update active button
      viewBtns.forEach(b => b.classList.remove('active'));
      this.classList.add('active');

      // Toggle views
      if (view === 'grid') {
        slidesGrid.style.display = 'grid';
        slidesList.style.display = 'none';
      } else {
        slidesGrid.style.display = 'none';
        slidesList.style.display = 'flex';
      }

      // Save preference
      localStorage.setItem('preferredView', view);
    });
  });

  // Load saved view preference
  const savedView = localStorage.getItem('preferredView');
  if (savedView) {
    const btn = document.querySelector(`[data-view="${savedView}"]`);
    if (btn) {
      btn.click();
    }
  }

  // Bookmark functionality
  const bookmarkBtns = document.querySelectorAll('.slide-bookmark');
  const bookmarks = JSON.parse(localStorage.getItem('slideBookmarks') || '[]');

  // Initialize bookmark states
  bookmarkBtns.forEach(btn => {
    const slideId = btn.getAttribute('data-slide-id');
    if (bookmarks.includes(slideId)) {
      btn.classList.add('bookmarked');
      btn.innerHTML = '<i class="fas fa-bookmark"></i>';
    }
  });

  bookmarkBtns.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const slideId = this.getAttribute('data-slide-id');
      const isBookmarked = this.classList.contains('bookmarked');

      if (isBookmarked) {
        // Remove bookmark
        this.classList.remove('bookmarked');
        this.innerHTML = '<i class="far fa-bookmark"></i>';
        const index = bookmarks.indexOf(slideId);
        if (index > -1) bookmarks.splice(index, 1);
      } else {
        // Add bookmark
        this.classList.add('bookmarked');
        this.innerHTML = '<i class="fas fa-bookmark"></i>';
        this.classList.add('animate');
        bookmarks.push(slideId);

        // Remove animation class after animation
        setTimeout(() => this.classList.remove('animate'), 600);
      }

      localStorage.setItem('slideBookmarks', JSON.stringify(bookmarks));
    });
  });

  // Progress tracking
  const slides = document.querySelectorAll('.slide-card, .slide-list-item');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const viewedSlides = JSON.parse(localStorage.getItem('viewedSlides') || '[]');
  const chapterId = {{ chapter.id }};

  // Update progress display
  function updateProgress() {
    const totalSlides = slides.length;
    const viewedCount = slides.length > 0 ?
      Array.from(slides).filter(slide => {
        const slideId = slide.getAttribute('data-slide-id');
        return viewedSlides.includes(slideId);
      }).length : 0;

    const percentage = totalSlides > 0 ? (viewedCount / totalSlides) * 100 : 0;

    if (progressFill && progressText) {
      progressFill.style.width = percentage + '%';
      progressText.textContent = `${viewedCount} / ${totalSlides} {{ t['slides'] if t.get('slides') else 'slides' }}`;
    }
  }

  updateProgress();

  // Add click handlers to slide cards for progress tracking
  slides.forEach(slide => {
    const links = slide.querySelectorAll('.btn-slide-view, a[href*="slide_detail"]');
    links.forEach(link => {
      link.addEventListener('click', function() {
        const slideId = slide.getAttribute('data-slide-id');
        if (!viewedSlides.includes(slideId)) {
          viewedSlides.push(slideId);
          localStorage.setItem('viewedSlides', JSON.stringify(viewedSlides));
        }

        // Add loading state
        slide.classList.add('loading');
      });
    });
  });

  // Intersection Observer for fade-in animations
  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      if (entry.isIntersecting) {
        entry.target.classList.add('fade-in');
      }
    });
  }, {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  });

  // Observe all slide cards
  slides.forEach(slide => {
    observer.observe(slide);
  });

  // Search functionality (if search input exists)
  const searchInput = document.getElementById('slideSearch');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      slides.forEach(slide => {
        const title = slide.querySelector('.slide-title, .slide-list-title').textContent.toLowerCase();
        const description = slide.querySelector('.slide-description, .slide-list-description')?.textContent.toLowerCase() || '';

        if (title.includes(searchTerm) || description.includes(searchTerm)) {
          slide.style.display = '';
        } else {
          slide.style.display = 'none';
        }
      });
    });
  }

  // Keyboard navigation
  document.addEventListener('keydown', function(e) {
    // Press 'G' for grid view
    if (e.key.toLowerCase() === 'g' && !e.ctrlKey && !e.metaKey) {
      const gridBtn = document.querySelector('[data-view="grid"]');
      if (gridBtn) gridBtn.click();
    }

    // Press 'L' for list view
    if (e.key.toLowerCase() === 'l' && !e.ctrlKey && !e.metaKey) {
      const listBtn = document.querySelector('[data-view="list"]');
      if (listBtn) listBtn.click();
    }
  });

  // Smooth scroll for anchor links
  document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });

  // Performance optimization: Lazy load images that are not visible
  if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const img = entry.target;
          if (img.dataset.src) {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
            observer.unobserve(img);
          }
        }
      });
    });

    document.querySelectorAll('img[data-src]').forEach(img => {
      imageObserver.observe(img);
    });
  }

  // Add tooltips for bookmark buttons
  bookmarkBtns.forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      const isBookmarked = this.classList.contains('bookmarked');
      this.title = isBookmarked ?
        '{{ t["remove_bookmark"] if t.get("remove_bookmark") else "Remove bookmark" }}' :
        '{{ t["add_bookmark"] if t.get("add_bookmark") else "Add bookmark" }}';
    });
  });

  // Auto-save scroll position
  let scrollTimeout;
  window.addEventListener('scroll', function() {
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      sessionStorage.setItem(`chapter_${chapterId}_scroll`, window.scrollY);
    }, 100);
  });

  // Restore scroll position
  const savedScroll = sessionStorage.getItem(`chapter_${chapterId}_scroll`);
  if (savedScroll) {
    setTimeout(() => {
      window.scrollTo(0, parseInt(savedScroll));
    }, 100);
  }

  // Mobile touch gestures for slide navigation
  let touchStartX = 0;
  let touchEndX = 0;

  document.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
  });

  document.addEventListener('touchend', function(e) {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });

  function handleSwipe() {
    const swipeThreshold = 50;
    const swipeDistance = touchEndX - touchStartX;

    if (Math.abs(swipeDistance) > swipeThreshold) {
      if (swipeDistance > 0) {
        // Swipe right - previous chapter
        const prevChapter = document.querySelector('.nav-chapter-btn');
        if (prevChapter) prevChapter.click();
      } else {
        // Swipe left - next chapter
        const nextChapter = document.querySelectorAll('.nav-chapter-btn')[1];
        if (nextChapter) nextChapter.click();
      }
    }
  }

  // Add loading states for better UX
  document.querySelectorAll('a[href*="slide_detail"]').forEach(link => {
    link.addEventListener('click', function() {
      // Add a subtle loading indicator
      this.style.opacity = '0.7';
      this.style.pointerEvents = 'none';

      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> {{ t["loading"] if t.get("loading") else "Loading..." }}';

      // Reset after a short delay if navigation doesn't happen
      setTimeout(() => {
        this.innerHTML = originalText;
        this.style.opacity = '';
        this.style.pointerEvents = '';
      }, 3000);
    });
  });
});
</script>
{% endblock %}