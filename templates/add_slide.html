<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Biology Study Material Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
        :root {
            --primary-blue: #2563eb;
            --primary-blue-dark: #1d4ed8;
            --success-green: #10b981;
            --error-red: #ef4444;
            --warning-orange: #f59e0b;
            --light-gray: #f8fafc;
            --medium-gray: #64748b;
            --dark-gray: #334155;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--dark-gray);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .page-header {
            text-align: center; margin-bottom: 40px; padding: 30px; background: white; border-radius: 15px; box-shadow: var(--shadow);
        }

        .page-title {
            color: var(--primary-blue); font-size: 2.5rem; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 15px;
        }
        .page-subtitle { color: var(--medium-gray); font-size: 1.2rem; }

        .flash-messages { position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px; }
        .flash-message { display: none; align-items: center; gap: 10px; padding: 15px 20px; margin-bottom: 10px; border-radius: 10px; box-shadow: var(--shadow); font-weight: 500; animation: slideIn 0.3s ease-out; }
        .flash-message.show { display: flex; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .flash-message.success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success-green); }
        .flash-message.error { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--error-red); }

        .form-container { background: white; border-radius: 15px; box-shadow: var(--shadow); overflow: hidden; }
        .form-grid { display: grid; gap: 30px; padding: 40px; }
        .form-section { border: 1px solid var(--border-color); border-radius: 10px; padding: 30px; background: #fafbfc; }
        .section-title { color: var(--primary-blue); font-size: 1.4rem; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--border-color); padding-bottom: 10px; }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .form-group { position: relative; }
        .form-label { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; color: var(--dark-gray); }
        .required { color: var(--error-red); }

        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px 15px; border: 2px solid var(--border-color); border-radius: 8px; font-size: 14px; transition: all 0.3s ease; background: white;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(37,99,235,.1); }
        .form-textarea { resize: vertical; min-height: 100px; }
        .form-textarea.large { min-height: 150px; }
        .char-counter { text-align: right; font-size: 12px; color: var(--medium-gray); margin-top: 5px; }
        .help-text { font-size: 12px; color: var(--medium-gray); margin-top: 5px; }

        /* Bullet sections */
        .bullet-section { background: white; border: 1px solid var(--border-color); border-radius: 10px; padding: 20px; margin-bottom: 20px; transition: all 0.3s ease; position: relative; }
        .bullet-section:hover { box-shadow: 0 2px 8px rgba(0,0,0,.1); }
        .bullet-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
        .bullet-section-title { display: flex; align-items: center; gap: 8px; font-weight: 600; color: var(--primary-blue); }
        .section-name-input { font-size: 16px; font-weight: 600; color: var(--primary-blue); border: none; background: transparent; border-bottom: 2px solid transparent; transition: all .3s ease; min-width: 120px; padding: 2px 0; }
        .section-name-input:focus { outline: none; border-bottom-color: var(--primary-blue); background: rgba(37,99,235,.05); padding: 2px 5px; border-radius: 3px; }
        .section-actions { display: flex; gap: 10px; }
        .add-bullet-btn { background: var(--primary-blue); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: all .3s ease; }
        .add-bullet-btn:hover { background: var(--primary-blue-dark); transform: translateY(-1px); }
        .remove-section-btn { background: var(--error-red); color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .3s ease; }
        .remove-section-btn:hover { background: #dc2626; transform: translateY(-1px); }
        .bullet-list { list-style: none; max-height: 400px; overflow-y: auto; }
        .bullet-item { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; transition: all .3s ease; animation: fadeInSlide .3s ease-out; }
        @keyframes fadeInSlide { from { opacity: 0; transform: translateY(-10px);} to { opacity:1; transform: translateY(0);} }
        .bullet-item:hover { background: #f1f5f9; border-color: var(--primary-blue); }
        .bullet-icon { color: var(--primary-blue); font-size: 12px; min-width: 15px; }
        .bullet-input { flex: 1; border: none; background: transparent; padding: 8px; font-size: 14px; color: var(--dark-gray); border-radius: 4px; transition: all .3s ease; }
        .bullet-input:focus { outline: none; background: white; box-shadow: 0 0 0 2px rgba(37,99,235,.15); }
        .remove-bullet-btn { background: none; border: none; color: var(--error-red); cursor: pointer; padding: 8px; border-radius: 4px; transition: all .3s ease; opacity: .6; }
        .remove-bullet-btn:hover { background: rgba(239,68,68,.1); opacity: 1; transform: scale(1.1); }
        .empty-state { text-align: center; padding: 30px; color: var(--medium-gray); font-style: italic; background: #f8fafc; border-radius: 8px; border: 2px dashed var(--border-color); }
        .empty-state i { font-size: 2rem; margin-bottom: 10px; display: block; opacity: .5; }

        /* Image upload */
        .image-upload-section { background: white; border: 2px dashed var(--border-color); border-radius: 10px; padding: 30px; transition: all .3s ease; }
        .upload-options { display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; }
        .upload-area { text-align: center; padding: 30px; border: 2px dashed var(--border-color); border-radius: 10px; cursor: pointer; transition: all .3s ease; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--primary-blue); background: rgba(37,99,235,.05); transform: scale(1.02); }
        .upload-icon { font-size: 2.5rem; color: var(--primary-blue); margin-bottom: 10px; }
        .upload-text { font-weight: 600; color: var(--dark-gray); margin-bottom: 5px; }
        .upload-hint { font-size: 12px; color: var(--medium-gray); }
        .divider { text-align: center; font-weight: 600; color: var(--medium-gray); position: relative; }
        .divider::before, .divider::after { content: ''; position: absolute; top: 50%; width: 20px; height: 1px; background: var(--border-color); }
        .divider::before { left: -30px; } .divider::after { right: -30px; }
        .url-input-area { text-align: center; }
        .file-input-hidden { display: none; }
        .image-preview-container { margin-top: 20px; display: none; animation: fadeIn .5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .image-preview-container.show { display: block; }
        .image-preview { position: relative; display: inline-block; border-radius: 10px; overflow: hidden; box-shadow: var(--shadow); }
        .image-preview img { max-width: 300px; max-height: 200px; object-fit: cover; display: block; }
        .image-preview-overlay { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .preview-btn { background: rgba(0,0,0,.7); color: white; border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; transition: all .3s ease; }
        .preview-btn:hover { background: rgba(0,0,0,.9); transform: scale(1.1); }

        .form-actions { display: flex; justify-content: space-between; gap: 15px; padding: 30px 40px; background: #f8fafc; border-top: 1px solid var(--border-color); align-items: center; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all .3s ease; font-size: 14px; }
        .btn-secondary { background: #f1f5f9; color: var(--dark-gray); border: 1px solid var(--border-color); }
        .btn-secondary:hover { background: #e2e8f0; transform: translateY(-1px); }
        .btn-success { background: var(--success-green); color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-1px); }
        .btn.loading { opacity: .7; cursor: not-allowed; }
        .btn.loading::after { content: ''; width: 16px; height: 16px; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin .8s linear infinite; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .section-counter { background: var(--primary-blue); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .section-template-selector { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border-color); }
        .template-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .template-btn { padding: 8px 15px; background: white; border: 1px solid var(--border-color); border-radius: 6px; font-size: 12px; cursor: pointer; transition: all .3s ease; display: flex; align-items: center; gap: 5px; }
        .template-btn:hover { border-color: var(--primary-blue); background: rgba(37,99,235,.05); }
        .database-indicator { position: absolute; top: 10px; right: 10px; background: var(--success-green); color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px; opacity: 0; transition: opacity .3s ease; }
        .database-indicator.show { opacity: 1; }

        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .upload-options { grid-template-columns: 1fr; }
            .page-title { font-size: 1.8rem; }
            .form-grid { padding: 20px; }
            .form-section { padding: 20px; }
            .bullet-section-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }

        /* Kurdish RTL Support */
        .rtl { direction: rtl; text-align: right; }
        .rtl .bullet-item { direction: rtl; }
        .rtl .form-row { direction: rtl; }

        @keyframes fadeOut { from { opacity: 1; transform: translateY(0);} to { opacity: 0; transform: translateY(-10px);} }

        /* Developer panel (hidden unless debug mode) */
        .dev-panel { display: none; align-items: center; gap: 10px; }
        .dev-panel.show { display: flex; }
        .dev-panel .status { font-size: 12px; color: var(--medium-gray); }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-microscope"></i>
                Biology Study Material Management
                <span style="font-size: .5em; color: var(--medium-gray);">بەڕێوەبردنی کەرەستەی خوێندنی بایۆلۆجی</span>
            </h1>
            <p class="page-subtitle">Add or edit study slides with interactive content / زیادکردن یان دەستکاریکردنی سلایدەکانی خوێندن</p>
        </div>

        <!-- Flash Messages -->
        <div class="flash-messages">
            <div class="flash-message success" id="successMessage">
                <i class="fas fa-check-circle"></i>
                <span id="success-text">Slide saved successfully!</span>
            </div>
            <div class="flash-message error" id="errorMessage">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-text">An error occurred. Please try again.</span>
            </div>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <form id="slideForm" method="POST" enctype="multipart/form-data">
                <div class="form-grid">

                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h2 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Basic Information / زانیاری بنەڕەتی
                        </h2>

                        <!-- Chapter Selection -->
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="chapter_id">
                                    <i class="fas fa-book"></i>
                                    Chapter / بابەت <span class="required">*</span>
                                </label>
                                <select class="form-select" id="chapter_id" name="chapter_id" required>
                                    <option value="">Select a chapter... / باب هەڵبژێرە</option>
                                    <option value="1">Chapter 1: Histology / باب ١: هیستۆلۆجی</option>
                                    <option value="2">Chapter 2: Embryology / باب ٢: ئێمبریۆلۆجی</option>
                                    <option value="3">Chapter 3: Plant Anatomy / باب ٣: ئەناتۆمیای ڕووەک</option>
                                    <option value="4">Chapter 4: Parasitology / باب ٤: پاراسیتۆلۆجی</option>
                                    <option value="5">Chapter 5: Hematology / باب ٥: هیماتۆلۆجی</option>
                                    <option value="6">Chapter 6: Microbiology / باب ٦: مایکرۆبایۆلۆجی</option>
                                    <option value="7">Chapter 7: Entomology / باب ٧: ئینتۆمۆلۆجی</option>
                                    <option value="8">Chapter 8: Algae Studies / باب ٨: خوێندنی ئاڵگا</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="order">
                                    <i class="fas fa-sort-numeric-up"></i>
                                    Display Order / ڕێزبەندی
                                </label>
                                <input type="number" class="form-input" id="order" name="order" value="1" min="1" max="999" />
                                <div class="help-text">Order in which this slide appears in the chapter / ڕێزبەندی ئەم سلایدە لە باب</div>
                            </div>
                        </div>

                        <!-- Titles -->
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="title_en">
                                    <i class="fas fa-heading"></i>
                                    Title (English) <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input" id="title_en" name="title_en" placeholder="Enter slide title in English" required maxlength="200" />
                                <div class="char-counter"><span id="title-en-count">0</span>/200</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="title_ckb">
                                    <i class="fas fa-heading"></i>
                                    Title (Kurdish) / سەرناو <span class="required">*</span>
                                </label>
                                <input type="text" class="form-input rtl" id="title_ckb" name="title_ckb" placeholder="سەرناوی سلاید بە کوردی بنووسە" required maxlength="200" />
                                <div class="char-counter"><span id="title-ckb-count">0</span>/200</div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Upload Section -->
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-image"></i>Study Material Image / وێنەی کەرەستەی خوێندن</h2>
                        <div class="image-upload-section" id="imageUploadSection">
                            <div class="upload-options">
                                <!-- File Upload Area -->
                                <div class="upload-area" id="uploadArea">
                                    <div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                                    <div class="upload-text">Select Image File / وێنە هەڵبژێرە</div>
                                    <div class="upload-hint">PNG, JPG, JPEG, GIF, WEBP (Max: 5MB)</div>
                                </div>
                                <div class="divider"><span>or / یان</span></div>
                                <!-- URL Input Area -->
                                <div class="url-input-area">
                                    <input type="text" class="form-input" id="image_url" name="image_url" placeholder="Provide Image URL / بەستەری وێنە بدە" value="" />
                                    <div class="help-text">Enter a direct link to an image hosted online</div>
                                </div>
                            </div>
                            <input type="file" id="imageFile" name="image" class="file-input-hidden" accept=".png,.jpg,.jpeg,.gif,.webp" />
                            <input type="hidden" id="image_filename" name="image_filename" value="" />
                            <input type="hidden" id="thumbnail_filename" name="thumbnail_filename" value="" />

                            <div class="image-preview-container" id="imagePreviewContainer">
                                <h3 class="section-title"><i class="fas fa-eye"></i>Image Preview / پێشبینینی وێنە</h3>
                                <div class="image-preview" id="imagePreview">
                                    <img id="previewImage" src="" alt="Preview" />
                                    <div class="image-preview-overlay">
                                        <button type="button" class="preview-btn" id="viewFullBtn" title="View Full Size"><i class="fas fa-expand"></i></button>
                                        <button type="button" class="preview-btn remove-image-btn" id="removeImageBtn" title="Remove Image"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Section -->
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-edit"></i>Study Content / ناوەڕۆکی خوێندن</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="content_en"><i class="fas fa-align-left"></i>Content (English)</label>
                                <textarea class="form-textarea large" id="content_en" name="content_en" placeholder="Detailed description and study notes in English" maxlength="2000"></textarea>
                                <div class="char-counter"><span id="content-en-count">0</span>/2000</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="content_ckb"><i class="fas fa-align-left"></i>Content (Kurdish) / ناوەڕۆک</label>
                                <textarea class="form-textarea large rtl" id="content_ckb" name="content_ckb" placeholder="ناوەڕۆکی تەواو و تێبینی خوێندن بە کوردی" maxlength="2000"></textarea>
                                <div class="char-counter"><span id="content-ckb-count">0</span>/2000</div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="form-section">
                        <h2 class="section-title"><i class="fas fa-list-ul"></i>Additional Study Details / زانیاری زیادی خوێندن</h2>
                        <div class="section-template-selector">
                            <label class="form-label"><i class="fas fa-magic"></i>Quick Add Sections / بەشە خێراکان</label>
                            <div class="help-text" style="margin-bottom: 10px;">Click to quickly add common biology study sections / کلیک بکە بۆ زیادکردنی بەشە باوەکان</div>
                            <div class="template-buttons">
                                <button type="button" class="template-btn" data-template="structure"><i class="fas fa-building"></i>Structure</button>
                                <button type="button" class="template-btn" data-template="function"><i class="fas fa-cogs"></i>Function</button>
                                <button type="button" class="template-btn" data-template="location"><i class="fas fa-map-marker-alt"></i>Location</button>
                                <button type="button" class="template-btn" data-template="components"><i class="fas fa-puzzle-piece"></i>Components</button>
                                <button type="button" class="template-btn" data-template="characteristics"><i class="fas fa-list-alt"></i>Characteristics</button>
                                <button type="button" class="template-btn" data-template="types"><i class="fas fa-tags"></i>Types</button>
                                <button type="button" class="template-btn" data-template="processes"><i class="fas fa-sync-alt"></i>Processes</button>
                                <button type="button" class="template-btn" data-template="benefits"><i class="fas fa-thumbs-up"></i>Benefits</button>
                            </div>
                        </div>
                        <div id="dynamicSectionsContainer"></div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" id="addCustomSectionBtn"><i class="fas fa-plus-circle"></i>Add Custom Section / بەشی تایبەت زیاد بکە</button>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <div class="dev-panel" id="devPanel">
                        <button type="button" class="btn btn-secondary" id="runTestsBtn" title="Run built-in tests">Run Tests</button>
                        <span class="status" id="testStatus"></span>
                    </div>
                    <div style="display:flex; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="window.history.back()"><i class="fas fa-times"></i>Cancel / هەڵوەشاندنەوە</button>
                        <button type="submit" class="btn btn-success" id="saveBtn"><i class="fas fa-save"></i>Save Study Material / پاشەکەوتکردن</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Custom Section Name -->
    <div id="customSectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%;">
            <h3 style="margin-bottom: 20px; color: var(--primary-blue);"><i class="fas fa-plus-circle"></i> Add Custom Section</h3>
            <div class="form-group">
                <label class="form-label">Section Name (English)</label>
                <input type="text" id="customSectionNameEn" class="form-input" placeholder="e.g., Clinical Significance" />
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label class="form-label">Section Name (Kurdish) / ناوی بەش</label>
                <input type="text" id="customSectionNameCkb" class="form-input rtl" placeholder="بۆ نموونە: گرنگی کلینیکی" />
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                <button type="button" class="btn btn-secondary" onclick="closeCustomSectionModal()">Cancel</button>
                <button type="button" class="btn btn-success" onclick="createCustomSection()">Create Section</button>
            </div>
        </div>
    </div>

    <script>
        'use strict';
        // =========================
        // Global state
        // =========================
        let currentSlideId = null;
        const sectionsData = new Map();
        let sectionCounter = 0;
        let autosaveInterval = null;

        // Queues to avoid API errors before slide is created
        const pendingSectionSaves = new Set();
        const pendingDeletes = new Set();

        const SECTION_TEMPLATES = {
            structure: { icon: 'fas fa-building', name_en: 'Structure', name_ckb: 'پێکهاتە', description: 'Anatomical or morphological structure' },
            function: { icon: 'fas fa-cogs', name_en: 'Function', name_ckb: 'کارەکان', description: 'Biological functions and roles' },
            location: { icon: 'fas fa-map-marker-alt', name_en: 'Location', name_ckb: 'شوێن', description: 'Anatomical location or habitat' },
            components: { icon: 'fas fa-puzzle-piece', name_en: 'Components', name_ckb: 'پێکهاتەکان', description: 'Main structural components' },
            characteristics: { icon: 'fas fa-list-alt', name_en: 'Characteristics', name_ckb: 'تایبەتمەندیەکان', description: 'Key characteristics and features' },
            types: { icon: 'fas fa-tags', name_en: 'Types', name_ckb: 'جۆرەکان', description: 'Different types and classifications' },
            processes: { icon: 'fas fa-sync-alt', name_en: 'Processes', name_ckb: 'پرۆسەکان', description: 'Biological processes involved' },
            benefits: { icon: 'fas fa-thumbs-up', name_en: 'Benefits', name_ckb: 'سوودەکان', description: 'Benefits and advantages' }
        };

        // =========================
        // Lifecycle
        // =========================
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            setupEventListeners();
            setupCharacterCounters();
            setupImageHandling();
            initializeTemplateButtons();
            initDevPanel();
            startAutosave();
            loadExistingData();
        });

        window.addEventListener('beforeunload', () => { if (autosaveInterval) clearInterval(autosaveInterval); });

        function initializeForm() {
            const urlParams = new URLSearchParams(window.location.search);
            currentSlideId = urlParams.get('slide_id');
            if (currentSlideId) { loadSlideData(currentSlideId); } else { createDefaultSections(); }
        }

        function createDefaultSections() {
            const defaults = ['components', 'location', 'function'];
            defaults.forEach(key => createSectionFromTemplate(key));
        }

        function setupEventListeners() {
            document.getElementById('slideForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('image_url').addEventListener('input', handleImageUrlChange);
            document.getElementById('removeImageBtn').addEventListener('click', removeImage);
            document.getElementById('viewFullBtn').addEventListener('click', viewFullImage);
            document.getElementById('addCustomSectionBtn').addEventListener('click', showCustomSectionModal);
        }

        function initializeTemplateButtons() {
            document.querySelectorAll('.template-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const template = this.dataset.template;
                    createSectionFromTemplate(template);
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => { this.style.transform = 'scale(1)'; }, 150);
                });
            });
        }

        // =========================
        // Section creation & editing
        // =========================
        function createSectionFromTemplate(templateKey) {
            const t = SECTION_TEMPLATES[templateKey]; if (!t) return;
            sectionCounter++; const sectionId = `section_${templateKey}_${sectionCounter}`;
            createSection(sectionId, t.name_en, t.name_ckb, t.icon);
        }

        function createSection(sectionId, nameEn, nameCkb, icon = 'fas fa-list') {
            const container = document.getElementById('dynamicSectionsContainer');
            sectionsData.set(sectionId, { id: sectionId, name_en: nameEn, name_ckb: nameCkb || nameEn, icon, items: [], created_at: new Date().toISOString() });

            const sectionHtml = `
                <div class="bullet-section" id="${sectionId}Section" data-section-id="${sectionId}">
                    <div class="database-indicator" id="${sectionId}DbIndicator"><i class="fas fa-database"></i> Saved</div>
                    <div class="bullet-section-header">
                        <div class="bullet-section-title">
                            <i class="${icon} section-icon"></i>
                            <span class="section-name-display">${nameEn}</span>
                            <input type="text" class="section-name-input" value="${nameEn}" data-section="${sectionId}" placeholder="Section Name" style="display:none;" />
                            <span class="section-counter" id="${sectionId}Counter">0</span>
                        </div>
                        <div class="section-actions">
                            <button type="button" class="add-bullet-btn" data-section="${sectionId}"><i class="fas fa-plus"></i>Add Item / زیادکردن</button>
                            <button type="button" class="btn btn-secondary" onclick="editSectionName('${sectionId}')" style="padding:8px 12px; font-size:12px;"><i class="fas fa-edit"></i></button>
                            <button type="button" class="remove-section-btn" onclick="removeSection('${sectionId}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="help-text" style="margin-bottom: 15px;">${nameCkb ? `${nameEn} / ${nameCkb}` : nameEn}</div>
                    <ul class="bullet-list" id="${sectionId}List">
                        <li class="empty-state"><i class="${icon}"></i> No items added yet. Click "Add Item" to start.<br>هیچ خاڵێک زیاد نەکراوە. "زیادکردن" کلیک بکە</li>
                    </ul>
                </div>`;

            container.insertAdjacentHTML('beforeend', sectionHtml);
            setupSectionEventListeners(sectionId);
            // IMPORTANT: Don't hit the API until we have a slide_id
            autosaveSection(sectionId);
        }

        function setupSectionEventListeners(sectionId) {
            const addBtn = document.querySelector(`button.add-bullet-btn[data-section="${sectionId}"]`);
            if (addBtn) addBtn.addEventListener('click', () => addBulletPoint(sectionId));

            const nameInput = document.querySelector(`input.section-name-input[data-section="${sectionId}"]`);
            if (nameInput) {
                nameInput.addEventListener('blur', () => saveSectionName(sectionId));
                nameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') { e.preventDefault(); nameInput.blur(); }
                    if (e.key === 'Escape') { cancelSectionEdit(sectionId); }
                });
            }
        }

        function addBulletPoint(sectionId, value = '', itemId = null) {
            const list = document.getElementById(`${sectionId}List`);
            const emptyState = list.querySelector('.empty-state'); if (emptyState) emptyState.style.display = 'none';

            const bulletId = itemId || `item_${sectionId}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
            const li = document.createElement('li'); li.className = 'bullet-item'; li.dataset.itemId = bulletId;
            li.innerHTML = `
                <i class="bullet-icon fas fa-circle"></i>
                <input type="text" class="bullet-input" placeholder="Enter item... / خاڵ زیاد بکە" value="${value}" data-section="${sectionId}" data-item-id="${bulletId}">
                <button type="button" class="remove-bullet-btn" onclick="removeBulletPoint('${bulletId}', '${sectionId}')"><i class="fas fa-trash"></i></button>`;
            list.appendChild(li);

            const input = li.querySelector('.bullet-input'); if (!value) input.focus();
            input.addEventListener('input', debounce(() => { saveBulletPoint(sectionId, bulletId, input.value); }, 500));
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addBulletPoint(sectionId); } });

            const sectionData = sectionsData.get(sectionId);
            if (sectionData) {
                const existing = sectionData.items.find(it => it.id === bulletId);
                if (!existing) {
                    sectionData.items.push({ id: bulletId, content_en: value, content_ckb: '', order: sectionData.items.length + 1, created_at: new Date().toISOString() });
                }
            }
            updateCounter(sectionId); showDatabaseIndicator(sectionId);
        }

        function removeBulletPoint(bulletId, sectionId) {
            const el = document.querySelector(`[data-item-id="${bulletId}"]`);
            if (el) {
                el.style.animation = 'fadeOut .3s ease-out';
                setTimeout(() => {
                    el.remove();
                    const sectionData = sectionsData.get(sectionId);
                    if (sectionData) sectionData.items = sectionData.items.filter(i => i.id !== bulletId);
                    updateEmptyState(sectionId); updateCounter(sectionId); autosaveSection(sectionId);
                }, 300);
            }
        }

        function saveBulletPoint(sectionId, itemId, content) {
            const sectionData = sectionsData.get(sectionId);
            if (!sectionData) return;
            const item = sectionData.items.find(i => i.id === itemId);
            if (item) { item.content_en = content.trim(); item.updated_at = new Date().toISOString(); autosaveSection(sectionId); }
        }

        function updateCounter(sectionId) {
            const counter = document.getElementById(`${sectionId}Counter`);
            const bullets = document.querySelectorAll(`#${sectionId}List .bullet-item`);
            if (counter) counter.textContent = String(bullets.length);
        }

        function updateEmptyState(sectionId) {
            const list = document.getElementById(`${sectionId}List`);
            const emptyState = list.querySelector('.empty-state');
            const bullets = list.querySelectorAll('.bullet-item');
            if (bullets.length === 0) { if (emptyState) emptyState.style.display = 'block'; }
            else { if (emptyState) emptyState.style.display = 'none'; }
        }

        function editSectionName(sectionId) {
            const nameDisplay = document.querySelector(`#${sectionId}Section .section-name-display`);
            const nameInput = document.querySelector(`#${sectionId}Section .section-name-input`);
            if (nameDisplay && nameInput) { nameDisplay.style.display = 'none'; nameInput.style.display = 'inline-block'; nameInput.focus(); nameInput.select(); }
        }

        function saveSectionName(sectionId) {
            const nameDisplay = document.querySelector(`#${sectionId}Section .section-name-display`);
            const nameInput = document.querySelector(`#${sectionId}Section .section-name-input`);
            if (nameDisplay && nameInput) {
                const newName = nameInput.value.trim();
                if (newName) {
                    nameDisplay.textContent = newName;
                    const sectionData = sectionsData.get(sectionId);
                    if (sectionData) { sectionData.name_en = newName; sectionData.updated_at = new Date().toISOString(); }
                    autosaveSection(sectionId);
                }
                nameDisplay.style.display = 'inline-block'; nameInput.style.display = 'none';
            }
        }

        function cancelSectionEdit(sectionId) {
            const nameDisplay = document.querySelector(`#${sectionId}Section .section-name-display`);
            const nameInput = document.querySelector(`#${sectionId}Section .section-name-input`);
            if (nameDisplay && nameInput) { nameInput.value = nameDisplay.textContent; nameDisplay.style.display = 'inline-block'; nameInput.style.display = 'none'; }
        }

        function removeSection(sectionId) {
            const sectionData = sectionsData.get(sectionId);
            const sectionName = sectionData ? sectionData.name_en : 'this section';
            if (confirm(`Are you sure you want to remove "${sectionName}"? / دڵنیایت لە سڕینەوەی "${sectionName}"؟`)) {
                const el = document.getElementById(`${sectionId}Section`);
                if (el) {
                    el.style.animation = 'fadeOut .3s ease-out';
                    setTimeout(() => {
                        el.remove();
                        sectionsData.delete(sectionId);
                        queueOrDeleteSection(sectionId);
                        showFlashMessage('success', 'Section removed successfully! / بەش بە سەرکەوتووی سڕایەوە!');
                    }, 300);
                }
            }
        }

        // =========================
        // API helpers (robust + slide-id bootstrap)
        // =========================
        const fd = new FormData();
fd.append('title_en', document.getElementById('title_en').value);
fd.append('title_ckb', document.getElementById('title_ckb').value);
fd.append('content_en', document.getElementById('content_en').value);
fd.append('content_ckb', document.getElementById('content_ckb').value);
fd.append('chapter_id', document.getElementById('chapter_id').value);
fd.append('order', document.getElementById('order').value);
fd.append('image_url', document.getElementById('image_url').value);
fd.append('components', document.getElementById('components')?.value || '');
fd.append('location', document.getElementById('location')?.value || '');
fd.append('functions', document.getElementById('functions')?.value || '');
fd.append('sections_data', JSON.stringify(Array.from(sectionsData.values())));

        function collectBasicFormData() {
            return {
                slide_id: currentSlideId,
                title_en: (document.getElementById('title_en')?.value || '').trim(),
                title_ckb: (document.getElementById('title_ckb')?.value || '').trim(),
                content_en: document.getElementById('content_en')?.value || '',
                content_ckb: document.getElementById('content_ckb')?.value || '',
                chapter_id: document.getElementById('chapter_id')?.value || '',
                order: document.getElementById('order')?.value || '1',
                image_url: document.getElementById('image_url')?.value || ''
            };
        }

        async function ensureSlideId() {
            if (currentSlideId) return currentSlideId;
            const payload = collectBasicFormData();
            try {
                const r = await fetch('/api/en/slide/autosave', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const d = await safeJson(r);
                if (d.success && d.slide_id) {
                    currentSlideId = d.slide_id;
                    try { window.history.replaceState({}, '', `?slide_id=${currentSlideId}`); } catch (_) {}
                    return currentSlideId;
                }
                throw new Error(d.message || 'Autosave failed to create slide_id');
            } catch (err) {
                console.error('ensureSlideId error:', err);
                showFlashMessage('error', 'Could not create a new draft yet. Type a title & chapter, then try again.');
                throw err;
            }
        }

        async function safeJson(resp) {
            const text = await resp.text();
            let data; try { data = JSON.parse(text); } catch { data = { success: false, message: 'Invalid JSON', raw: text }; }
            if (!resp.ok && !data.message) data.message = `HTTP ${resp.status}`;
            return data;
        }

        async function autosaveSection(sectionId) {
            const sectionData = sectionsData.get(sectionId); if (!sectionData) return;
            if (!currentSlideId) {
                // queue save until slide exists
                pendingSectionSaves.add(sectionId);
                try {
                    await ensureSlideId();
                    if (pendingSectionSaves.has(sectionId)) { await actuallySaveSection(sectionId); pendingSectionSaves.delete(sectionId); }
                } catch (err) {
                    console.error('Error saving section (no slide id yet):', err);
                }
                return;
            }
            return actuallySaveSection(sectionId);
        }

        async function actuallySaveSection(sectionId) {
            const sectionData = sectionsData.get(sectionId); if (!sectionData) return;
            const apiData = { slide_id: currentSlideId, section_data: sectionData };
            try {
                const r = await fetch('/api/en/slide/section/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(apiData) });
                const d = await safeJson(r);
                if (d.success) { showDatabaseIndicator(sectionId); }
                else { throw new Error(d.message || 'Unknown error'); }
            } catch (err) {
                console.error('Error saving section:', err);
                showFlashMessage('error', dMessage(err, 'Could not save section.'));
            }
        }

        function dMessage(err, fallback) { return err?.message || fallback || 'Error'; }

        async function queueOrDeleteSection(sectionId) {
            if (!currentSlideId) { pendingDeletes.add(sectionId); return; }
            try {
                const r = await fetch(`/api/en/slide/section/${sectionId}/delete`, { method: 'DELETE', headers: { 'Content-Type': 'application/json' } });
                const d = await safeJson(r);
                if (!d.success) throw new Error(d.message || 'Delete failed');
            } catch (err) {
                console.error('Error deleting section:', err);
                showFlashMessage('error', dMessage(err, 'Could not delete section.'));
            }
        }

        function flushPendingDeletes() {
            if (!currentSlideId || pendingDeletes.size === 0) return;
            [...pendingDeletes].forEach(id => { pendingDeletes.delete(id); queueOrDeleteSection(id); });
        }

        function showDatabaseIndicator(sectionId) {
            const indicator = document.getElementById(`${sectionId}DbIndicator`);
            if (indicator) { indicator.classList.add('show'); setTimeout(() => indicator.classList.remove('show'), 2000); }
        }

        function startAutosave() { autosaveInterval = setInterval(() => { autoSaveBasicForm(); }, 30000); }

        async function autoSaveBasicForm() {
            const formData = collectBasicFormData();
            try {
                const r = await fetch('/api/en/slide/autosave', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(formData) });
                const d = await safeJson(r);
                if (d.success) {
                    if (!currentSlideId && d.slide_id) {
                        currentSlideId = d.slide_id;
                        try { window.history.replaceState({}, '', `?slide_id=${currentSlideId}`); } catch (_) {}
                        flushPendingDeletes();
                        // save any queued sections
                        [...pendingSectionSaves].forEach(async id => { await actuallySaveSection(id); pendingSectionSaves.delete(id); });
                    }
                } else {
                    console.error('Error auto-saving (server returned error):', d.message);
                }
            } catch (err) {
                console.error('Error auto-saving:', err);
            }
        }

        function loadExistingData() {
            if (!currentSlideId) return;
            fetch(`/api/en/slide/${currentSlideId}/sections`).then(r => r.json()).then(d => { if (d.success) loadSectionsFromServer(d.sections); })
                .catch(err => console.error('Error loading sections:', err));
        }
        function loadSectionsFromServer(sections) {
            const container = document.getElementById('dynamicSectionsContainer');
            container.innerHTML = '';
            sections.forEach(section => {
                sectionsData.set(section.id, { ...section, items: [] });
                createSection(section.id, section.name_en, section.name_ckb, section.icon);
                // now add items
                (section.items || []).forEach(item => { addBulletPoint(section.id, item.content_en, item.id); });
                showDatabaseIndicator(section.id);
            });
        }
        function loadSlideData(slideId) {
            fetch(`/api/en/slide/${slideId}`).then(r => r.json()).then(d => {
                if (!d.success) return;
                const s = d.slide;
                document.getElementById('chapter_id').value = s.chapter_id;
                document.getElementById('order').value = s.order;
                document.getElementById('title_en').value = s.title_en;
                document.getElementById('title_ckb').value = s.title_ckb;
                document.getElementById('content_en').value = s.content_en || '';
                document.getElementById('content_ckb').value = s.content_ckb || '';
                document.getElementById('image_url').value = s.image_url || '';
                // Update counters
                document.querySelectorAll('[id$="-count"]').forEach(counter => {
                    const fieldId = counter.id.replace('-count','').replace('-','_');
                    const field = document.getElementById(fieldId);
                    if (field) field.dispatchEvent(new Event('input'));
                });
                if (s.image_filename || s.image_url) {
                    const url = s.image_filename ? `/uploads/slides/${s.image_filename}` : s.image_url;
                    showImagePreview(url);
                }
            }).catch(err => console.error('Error loading slide data:', err));
        }

        // =========================
        // Submit
        // =========================
        async function handleFormSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('saveBtn');
            const original = submitBtn.innerHTML;
            submitBtn.classList.add('loading');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving... / پاشەکەوت دەکرێت...';
            submitBtn.disabled = true;

            try {
                await ensureSlideId();
                const fd = new FormData(e.target);
                const sectionsArray = Array.from(sectionsData.values());
                fd.append('sections_data', JSON.stringify(sectionsArray));

                const url = currentSlideId ? `/api/en/slide/${currentSlideId}/update` : '/api/en/slide/create';
                const r = await fetch(url, { method: 'POST', body: fd });
                const d = await safeJson(r);
                if (d.success) {
                    showFlashMessage('success', d.message || 'Study material saved successfully! / کەرەستەی خوێندن بە سەرکەوتووی پاشەکەوت کرا!');
                    if (!currentSlideId && d.slide_id) { currentSlideId = d.slide_id; try { window.history.replaceState({}, '', `?slide_id=${currentSlideId}`); } catch (_) {} }
                } else {
                    showFlashMessage('error', d.message || 'Error saving slide / هەڵە لە پاشەکەوتکردن');
                }
            } catch (err) {
                console.error('Submit error:', err);
                showFlashMessage('error', dMessage(err, 'Network error. Please try again. / هەڵەی تۆڕ. دووبارە هەوڵ بدەرەوە'));
            } finally {
                submitBtn.classList.remove('loading'); submitBtn.innerHTML = original; submitBtn.disabled = false;
            }
        }

        // =========================
        // Text counters
        // =========================
        function setupCharacterCounters() {
            const fields = [
                { id: 'title_en', counter: 'title-en-count', max: 200 },
                { id: 'title_ckb', counter: 'title-ckb-count', max: 200 },
                { id: 'content_en', counter: 'content-en-count', max: 2000 },
                { id: 'content_ckb', counter: 'content-ckb-count', max: 2000 }
            ];
            fields.forEach(f => {
                const input = document.getElementById(f.id);
                const counter = document.getElementById(f.counter);
                if (input && counter) {
                    const update = () => {
                        const length = input.value.length;
                        counter.textContent = String(length);
                        const pct = (length / f.max) * 100;
                        if (pct > 90) counter.style.color = 'var(--error-red)';
                        else if (pct > 75) counter.style.color = 'var(--warning-orange)';
                        else counter.style.color = 'var(--medium-gray)';
                    };
                    input.addEventListener('input', update);
                    update();
                }
            });
        }

        // =========================
        // Image handling
        // =========================
        function setupImageHandling() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('imageFile');

            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files && e.dataTransfer.files[0]) { handleSelectedFile(e.dataTransfer.files[0]); }
            });
            fileInput.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) handleSelectedFile(e.target.files[0]); });
        }
        function handleSelectedFile(file) {
            const valid = ['image/png','image/jpeg','image/jpg','image/gif','image/webp'];
            if (!valid.includes(file.type)) { showFlashMessage('error', 'Invalid file type.'); return; }
            if (file.size > 5 * 1024 * 1024) { showFlashMessage('error', 'File too large (max 5MB).'); return; }
            const reader = new FileReader();
            reader.onload = (e) => { showImagePreview(e.target.result); };
            reader.readAsDataURL(file);
        }
        function handleImageUrlChange(e) {
            const url = e.target.value.trim();
            if (!url) return removeImage();
            // light validation
            if (/^https?:\/\//i.test(url)) { showImagePreview(url); }
        }
        function showImagePreview(src) {
            const container = document.getElementById('imagePreviewContainer');
            const img = document.getElementById('previewImage');
            img.onerror = () => { showFlashMessage('error', 'Could not load image preview.'); };
            img.src = src; container.classList.add('show');
        }
        function removeImage() {
            const container = document.getElementById('imagePreviewContainer');
            const img = document.getElementById('previewImage');
            img.src = ''; container.classList.remove('show');
            document.getElementById('image_url').value = '';
            document.getElementById('imageFile').value = '';
        }
        function viewFullImage() {
            const src = document.getElementById('previewImage').src;
            if (src) window.open(src, '_blank');
        }

        // =========================
        // Utils
        // =========================
        function debounce(fn, delay = 300) { let t; return function(...args){ clearTimeout(t); t = setTimeout(() => fn.apply(this, args), delay); }; }
        function showFlashMessage(type, text) {
            const el = type === 'success' ? document.getElementById('successMessage') : document.getElementById('errorMessage');
            const span = type === 'success' ? document.getElementById('success-text') : document.getElementById('error-text');
            span.textContent = text; el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2500);
        }

        // =========================
        // Developer tests (run in browser)
        // =========================
        function initDevPanel() {
            const params = new URLSearchParams(window.location.search);
            const isDebug = params.get('debug') === '1';
            const panel = document.getElementById('devPanel');
            if (isDebug && panel) panel.classList.add('show');
            const runBtn = document.getElementById('runTestsBtn');
            runBtn?.addEventListener('click', runTests);
        }

        function runTests() {
            const statusEl = document.getElementById('testStatus');
            const results = [];
            const assert = (name, cond) => { results.push({ name, pass: !!cond }); if (!cond) console.error('Test failed:', name); };

            // --- Test 1: ensureSlideId bootstraps slide id (mocked fetch)
            (function testEnsureSlideId(){
                const originalFetch = window.fetch;
                let calls = [];
                window.fetch = (url, opts) => {
                    calls.push(url);
                    if (url.includes('/api/en/slide/autosave')) {
                        return Promise.resolve(new Response(JSON.stringify({ success: true, slide_id: 'SLIDE_X' }), { status: 200 }));
                    }
                    return originalFetch(url, opts);
                };
                currentSlideId = null;
                ensureSlideId().then(id => {
                    assert('ensureSlideId returns id', id === 'SLIDE_X');
                    assert('history updated (optional)', true);
                    window.fetch = originalFetch;
                }).catch(e => { console.error(e); window.fetch = originalFetch; });
            })();

            // --- Test 2: autosaveSection queues then saves (mocked fetch order)
            (function testAutosaveSectionQueue(){
                const originalFetch = window.fetch;
                let order = [];
                window.fetch = (url, opts) => {
                    order.push(url);
                    if (url.includes('/api/en/slide/autosave')) {
                        return Promise.resolve(new Response(JSON.stringify({ success: true, slide_id: 'SLIDE_Y' }), { status: 200 }));
                    }
                    if (url.includes('/api/en/slide/section/save')) {
                        return Promise.resolve(new Response(JSON.stringify({ success: true }), { status: 200 }));
                    }
                    return originalFetch(url, opts);
                };
                currentSlideId = null;
                const sid = 'test_section_1';
                sectionsData.set(sid, { id: sid, name_en: 'Test', name_ckb: 'تاقیکردنەوە', icon: 'fas fa-list', items: [] });
                autosaveSection(sid).then(() => {
                    const firstIsAutosave = order[0]?.includes('/autosave');
                    const secondIsSave = order[1]?.includes('/section/save');
                    assert('autosaveSection calls autosave then save', firstIsAutosave && secondIsSave);
                    window.fetch = originalFetch;
                }).catch(e => { console.error(e); window.fetch = originalFetch; });
            })();

            // --- Test 3: counter updates
            (function testCounter(){
                const sid = 'test_section_2';
                createSection(sid, 'Counter', 'ژمێرە');
                addBulletPoint(sid, 'A');
                addBulletPoint(sid, 'B');
                const c = document.getElementById(`${sid}Counter`).textContent.trim();
                assert('counter shows 2', c === '2');
            })();

            // Display summary
            const passCount = results.filter(r => r.pass).length;
            statusEl.textContent = `Tests passed: ${passCount}/${results.length}`;
            showFlashMessage(passCount === results.length ? 'success' : 'error', statusEl.textContent);
        }
    </script>
</body>
</html>
